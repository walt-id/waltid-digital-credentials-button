<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Digital Credential Button Demo</title>
    <script type="module" src="../dist/index.js"></script>
    <script type="module" src="./mock-environment.js"></script>
    <style>
      :root {
        color: #0f172a;
        background: #f1f5f9;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      body {
        margin: 0;
        padding: 0;
      }
      main {
        max-width: 720px;
        margin: 0 auto;
        padding: 48px 24px 64px;
      }
      h1 {
        font-size: 2rem;
        margin: 0 0 0.5rem;
      }
      p.lead {
        margin: 0 0 1.5rem;
        color: #334155;
      }
      section.card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid #e2e8f0;
      }
      pre {
        background: #0f172a;
        color: #e2e8f0;
        padding: 16px;
        border-radius: 12px;
        overflow: auto;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Digital Credential Button</h1>
      <p class="lead">
        A minimal web component that fetches a Digital Credential API request from a backend,
        calls <code>navigator.credentials.get</code>, and posts the result back.
      </p>

      <section class="card" style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <strong>Mock mode</strong>
          <span id="mock-status"></span>
          <button id="mock-toggle">Toggle mock</button>
          <small style="color:#475569;">Uses builtin JSON fixtures when enabled.</small>
        </div>
      </section>

      <section class="card">
        <digital-credential-button
          id="demo-btn"
          config-endpoint="/api/dc/config"
          label="Request credentials"
        ></digital-credential-button>

        <h3>Event log</h3>
        <pre id="log">(click the button to start)</pre>
      </section>
    </main>

    <script type="module">
      const logEl = document.getElementById('log');
      const btn = document.getElementById('demo-btn');
      const mockStatus = document.getElementById('mock-status');
      const mockToggle = document.getElementById('mock-toggle');
      const MOCK_FLAG_KEY = 'dc-mock-enabled';

      const log = (label, data) => {
        const entry = {
          timestamp: new Date().toISOString(),
          label,
          data
        };
        logEl.textContent = `${JSON.stringify(entry, null, 2)}\n\n${logEl.textContent}`;
      };

      btn.addEventListener('credential-request-started', () => log('credential-request-started'));
      btn.addEventListener('credential-received', (event) =>
        log('credential-received', event.detail)
      );
      btn.addEventListener('credential-error', (event) =>
        log('credential-error', event.detail)
      );

      function getMockEnabled() {
        return localStorage.getItem(MOCK_FLAG_KEY) === 'true';
      }

      function setMockEnabled(next) {
        localStorage.setItem(MOCK_FLAG_KEY, String(next));
        const url = new URL(window.location.href);
        url.searchParams.set('dc-mock', next ? '1' : '0');
        window.location.assign(url.toString());
      }

      function renderMockStatus() {
        const enabled = getMockEnabled();
        mockStatus.textContent = enabled ? 'ON' : 'OFF';
        mockStatus.style.color = enabled ? '#16a34a' : '#dc2626';
        mockToggle.textContent = enabled ? 'Disable' : 'Enable';
      }

      mockToggle.addEventListener('click', () => {
        setMockEnabled(!getMockEnabled());
      });

      renderMockStatus();
    </script>
  </body>
</html>
